<head>
  <meta charset="utf-8" />

  <script src="https://apis.google.com/js/platform.js?onload=gInit" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js" async defer></script>
</head>

Sign in to your Google Cloud account:
<div id="googleSignIn" style="height: 20px"></div><div id="googleSignInOut" style="height: 20px" hidden><button>Sign out</button></div>
<br/>
<button onclick="window.test()">test</button>

<script type="module">
  const CLOUD_FUNCTION_NAME = "award-man"
  const CLOUD_FUNCTIONS_LOCATION = "us-central1"
  const SCRAPERS = ["united", "aeroplan"]
  const SCRAPER_DIR = "scrapers"

  /* global gapi */
  window.gInit = () => {
    gapi.load("client:auth2", async () => {
      /* eslint-disable camelcase */
      await gapi.client.init({
        discoveryDocs: ["https://cloudfunctions.googleapis.com/$discovery/rest?version=v1"],
        client_id: "224829437062-cfk51jtehv7mbeq5i60uf82n11s343rr.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/cloudfunctions https://www.googleapis.com/auth/cloud-platform"
      })
      await gapi.client.load({name: "cloudfunctions", version: "v1"})
      /* eslint-enable camelcase */

      gapi.signin2.render("googleSignIn", {
        theme: "dark",
        prompt: "select_account",
        onFailure: error => console.error(error),
        onSuccess: () => {
          document.querySelector("#googleSignIn").hidden = true
          document.querySelector("#googleSignInOut").hidden = false
          document.querySelector("#googleSignInOut button").onclick = () => {
            gapi.auth2.getAuthInstance().signOut().then(() => {
              document.querySelector("#googleSignIn").hidden = false
              document.querySelector("#googleSignInOut").hidden = true
            })
          }
        }
      })
    })
  }

  const waitForOperation = async (opName, attemptDelayMs, maxAttempts) => {
    const delay = ms => new Promise(res => setTimeout(res, ms))

    for (let loopNo = 0; loopNo < maxAttempts; loopNo++) {
      await delay(attemptDelayMs)

      const op = await gapi.client.cloudfunctions.operations.get({name: opName})
      if (op.result.done) {
        if (op.result.error)
          throw op.result.error.message
        return op.result.response
      }
    }
    throw `Timeout waiting for operation ${opName}`
  }

  window.test = async() => {
    console.log("Prepping package...")
    let zip = new JSZip()
    const scrapersAndIndex = SCRAPERS.concat("index")
    for (const scraperName of scrapersAndIndex) {
      const scraperCode = await fetch(`${SCRAPER_DIR}/${scraperName}.js`).then(result => result.text())
      zip.file(`${scraperName}.js`, scraperCode, {date: new Date("December 25, 2007 00:00:01")})  // date to make hashing consistent
    }
    const zipFile = await zip.generateAsync({type:"arraybuffer"})
    const zipFileHash = SparkMD5.ArrayBuffer.hash(zipFile).substr(0, 5)

    console.log("Getting if GCF has up to date scrapers...")
    const location = `projects/${CLOUD_FUNCTION_NAME}/locations/${CLOUD_FUNCTIONS_LOCATION}`
    const functionName = `${location}/functions/${CLOUD_FUNCTION_NAME}`
    let functionOnlyNeedsPatch = false
    try {
      const existingFunc = await gapi.client.cloudfunctions.projects.locations.functions.get({name: functionName})
      if (existingFunc.result.description === zipFileHash) {
        console.log("Scrapers are up to date!")
        return
      }
      functionOnlyNeedsPatch = true
    } catch (e) {
      if (e.status !== 404)
        throw e
    }

    console.log("Getting file upload url...")
    const uploadUrlResp = await gapi.client.cloudfunctions.projects.locations.functions.generateUploadUrl({parent: location})
    const uploadUrl = uploadUrlResp.result.uploadUrl

    // WARNING: ABSOLUTELY NASTY HACK SINCE GOOGLE FUNCTIONS HAS A CORS BUG
    // see https://issuetracker.google.com/issues/114650724
    console.log("Uploading scrapers via CORS-Anywhere...")
    const noCorsUploadUrl = uploadUrl.replace("https://","https://cors-anywhere.herokuapp.com/")
    await (await fetch(noCorsUploadUrl, {method: "PUT", headers: {"content-type": "application/zip", "x-goog-content-length-range": "0,104857600"}, body: zipFile})).text()

    console.log(`${functionOnlyNeedsPatch ? "Updating" : "Creating"} function...`)
    const funcParams = {
      name: functionName,
      description: zipFileHash,
      sourceUploadUrl: uploadUrl,
      "httpsTrigger": {},
      "runtime": "nodejs8",
      "availableMemoryMb": 2048,
      "entryPoint": "gcfEntry"
    }
    let operationResp = null
    if (functionOnlyNeedsPatch) {
      operationResp = await gapi.client.cloudfunctions.projects.locations.functions.patch({name: functionName, updateMask: Object.keys(funcParams).join(","), resource: funcParams})
    } else {
      operationResp = await gapi.client.cloudfunctions.projects.locations.functions.create({location: location, resource: funcParams})
    }
    const operationName = operationResp.result.name

    console.log("Waiting for function to be ready...")
    await waitForOperation(operationName, 5000, 12)
    
    console.log("Ready!")
  }
</script>
  